<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi√°ng Sinh Y√™u Th∆∞∆°ng 3D</title>
    <!-- Import font ch·ªØ ƒë·∫πp -->
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome cho icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- C·∫•u h√¨nh th∆∞ vi·ªán 3D v√† AI -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
            }
        }
    </script>

    <style>
        /* --- CSS G·ªêC C·ª¶A INDEX (ƒê√£ ch·ªânh s·ª≠a) --- */
        :root { --primary-red: #ff3333; --primary-green: #2ecc71; --gold: #ffd700; --snow-white: #f0f8ff; --text-dark: #2c3e50; }
        body { margin: 0; padding: 0; font-family: 'Quicksand', sans-serif; overflow: hidden; background-color: #0f172a; height: 100vh; width: 100vw; color: white; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; } 
        .flex-center { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; text-align: center; }
        .btn { background: var(--primary-red); color: white; border: 2px solid white; padding: 12px 30px; font-size: 1.2rem; border-radius: 25px; cursor: pointer; font-family: 'Mountains of Christmas', cursive; transition: all 0.3s; box-shadow: 0 4px 15px rgba(212, 36, 38, 0.5); margin-top: 20px; z-index: 100; position: relative; }
        .btn:hover { transform: scale(1.05); background: #b01b1d; }
        .btn-blue { background: #0084ff; border-color: #0066cc; box-shadow: 0 4px 15px rgba(0, 132, 255, 0.4); }
        .btn-blue:hover { background: #0066cc; }
        .btn-green { background: var(--primary-green); border-color: #0f3d22; }
        .btn-green:hover { background: #0f3d22; }
        .btn-control { background: #333; color: white; font-size: 0.9rem; padding: 5px 15px; border-radius: 15px; margin-top: 5px; border: none; cursor: pointer; }
        .btn-control:hover { background: #555; }

        /* Stage 1 & 2 gi·ªØ nguy√™n */
        #stage-1 { background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=1920&auto=format&fit=crop'); background-size: cover; background-position: center; position: absolute; top:0; left:0; z-index: 200; }
        .input-box { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 15px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); color: #333; max-width: 90%; width: 350px; position: relative;}
        .input-box h2 { font-family: 'Mountains of Christmas', cursive; font-size: 2rem; color: var(--primary-green); margin-top: 0; }
        input[type="text"], textarea { width: 80%; padding: 10px; border: 2px solid var(--primary-green); border-radius: 5px; font-size: 1rem; text-align: center; outline: none; }
        textarea { height: 80px; text-align: left; }

        #stage-2 { background-color: #000; position: absolute; top:0; left:0; z-index: 190; width: 100vw; height: 100vh; }
        .light-bulbs-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .bulb { position: absolute; width: 15px; height: 15px; border-radius: 50%; background: #222; transition: all 0.2s; opacity: 0; }
        .bulb.on { opacity: 1; box-shadow: 0 0 15px 5px currentColor; animation: flash 0.8s ease-in-out; }
        @keyframes flash { 0% { transform: scale(1); opacity: 0; } 10% { transform: scale(1.5); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(1); opacity: 0; } }
        
        #light-btn { position: absolute; bottom: 10%; left: 50%; transform: translateX(-50%); margin-top: 0; }

        /* Stage 3 - N·ªÄN XANH TUY·∫æT & ƒê·ªíI N√öI */
        #stage-3 { 
            background: linear-gradient(to bottom, #1a2a6c, #b21f1f, #fdbb2d); /* Fallback */
            background: linear-gradient(to bottom, #0f2027, #203a43, #d6eaf8); /* Xanh tuy·∫øt t·ª´ t·ªëi ƒë·∫øn s√°ng */
            position: absolute; top: 0; left: 0; height: 100vh; width: 100vw; overflow: hidden; z-index: 50; 
            color: var(--text-dark); 
        }

        /* Th√™m n√∫i ph√≠a sau */
        .mountain-bg {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40vh; z-index: 2; pointer-events: none;
            background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,0.8) 100%);
        }
        .mountain-1 {
            position: absolute; bottom: 0; left: -20%; width: 70%; height: 35vh; 
            background: #e3f2fd; border-radius: 100% 0 0 0; transform: skewX(-20deg); z-index: 1;
        }
        .mountain-2 {
            position: absolute; bottom: 0; right: -20%; width: 80%; height: 45vh; 
            background: #d6eaf8; border-radius: 0 100% 0 0; transform: skewX(20deg); z-index: 1;
        }

        #canvas-3d-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; pointer-events: auto; }
        
        #webcam-wrapper { display: none; }

        #ai-loader {
            position: absolute; top: 10px; right: 10px; z-index: 200;
            color: #d4af37; font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
            background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 5px;
        }

        .fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 4; }
        .firework-particle { position: absolute; width: 6px; height: 6px; border-radius: 50%; animation: explode 1s ease-out forwards; }
        @keyframes explode { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        
        .clouds-container { position: absolute; top: 0; left: 0; width: 100%; height: 50%; pointer-events: none; z-index: 3; opacity: 0.8; }
        .cloud { position: absolute; width: 150px; opacity: 0.9; animation: floatCloud 30s linear infinite; filter: brightness(1.2); } 
        @keyframes floatCloud { from { transform: translateX(-200px); } to { transform: translateX(110vw); } }
        
        .snow-hill { position: absolute; bottom: 0; left: 0; width: 100%; height: 20vh; background: #ffffff; border-radius: 100% 100% 0 0 / 50% 50% 0 0; transform: scaleX(1.5); z-index: 3; box-shadow: 0 -5px 20px rgba(176, 196, 222, 0.5); pointer-events: none; }
        
        .santa-fly { position: absolute; top: 10%; left: -300px; width: 250px; z-index: 4; animation: flyAcross 20s linear infinite; }
        .santa-fly img { width: 100%; }
        @keyframes flyAcross { 0% { transform: translateX(0) translateY(0); } 25% { transform: translateX(30vw) translateY(-40px); } 50% { transform: translateX(60vw) translateY(0); } 75% { transform: translateX(90vw) translateY(-40px); } 100% { transform: translateX(120vw) translateY(0); } }
        
        .decor-gift { position: absolute; z-index: 6; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); transition: transform 0.3s; width: 50px; }
        .decor-gift:hover { transform: scale(1.1) translateY(-5px); }
        
        #special-gift-container { position: absolute; bottom: 15vh; left: 50%; transform: translateX(-50%) scale(0); z-index: 100; transition: transform 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; }
        #special-gift-container.show { transform: translateX(-50%) scale(1); }
        .big-gift-img { width: 140px; cursor: pointer; filter: drop-shadow(0 0 20px gold); animation: shake 2s infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-8deg); } 75% { transform: rotate(8deg); } }
        
        .snowflake { position: absolute; top: -10px; color: #fff; font-size: 1.2em; font-family: Arial, sans-serif; text-shadow: 0 0 2px #a9cce3; z-index: 5; animation: fall linear infinite; opacity: 0.8; }
        @keyframes fall { to { transform: translateY(105vh); } }
        
        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 300; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content { background: #fffafa; color: #333; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; text-align: center; border: 5px solid var(--primary-red); position: relative; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 50px rgba(212, 36, 38, 0.5); }
        
        .letter-gift { background: #fffde7; padding: 20px; border: 1px dashed #999; font-family: 'Times New Roman', serif; font-size: 1.2rem; line-height: 1.6; text-align: left; white-space: pre-wrap; }
        
        .video-container { width: 100%; margin-top: 10px; background: #000; border-radius: 10px; overflow: hidden; min-height: 200px; display: flex; align-items: center; justify-content: center; }
        .video-container video { width: 100%; height: auto; display: block; max-height: 250px; }

        /* Tiktok Logo nh·ªè h∆°n */
        .tiktok-logo { 
            position: fixed; bottom: 20px; left: 20px; 
            width: 25px; /* Nh·ªè n·ªØa */
            z-index: 150; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); 
            cursor: pointer; transition: transform 0.1s; 
        }
        .tiktok-logo:active { transform: scale(0.9); }
        
        .user-gift-meta { font-size: 0.9rem; color: #666; font-style: italic; margin-top: 10px; border-top: 1px solid #ddd; padding-top: 5px; }
        .signature-fr { display: block; text-align: right; margin-top: 15px; font-weight: bold; color: var(--primary-green); font-style: italic; }

        #share-form { display: none; margin-top: 15px; border-top: 2px dashed #ddd; padding-top: 15px; }
        .share-type-selector { display: none; }
        .guide-text { text-align: left; line-height: 1.6; font-size: 1rem; }
        .guide-text li { margin-bottom: 8px; }

        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 1000; pointer-events: none;
        }
        .toast {
            background: rgba(255, 255, 255, 0.95); color: #333;
            padding: 15px 25px; border-radius: 50px;
            margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-family: 'Quicksand', sans-serif; font-weight: bold;
            display: flex; align-items: center; gap: 10px;
            border: 2px solid var(--primary-green);
            opacity: 0; transform: translateY(-20px);
            transition: all 0.4s ease;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast i { color: var(--primary-red); font-size: 1.2rem; }
        
        /* ·∫®n control 3D th·ª´a */
        #ui-3d-controls { display: none; }
    </style>
</head>
<body>

    <!-- STAGE 1: NH·∫¨P T√äN -->
    <div id="stage-1" class="flex-center">
        <div class="input-box">
            <h2><i class="fas fa-sleigh"></i> Ch√†o b·∫°n!</h2>
            <p>Cho m√¨nh bi·∫øt t√™n b·∫°n l√† g√¨ nh·ªâ?</p>
            <input type="text" id="user-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn btn-green" onclick="window.showGuideModal()" style="font-size: 1rem; padding: 10px 20px; margin-top: 0;">
                    <i class="fas fa-question-circle"></i> H∆∞·ªõng d·∫´n sd web
                </button>
                <button class="btn" id="btn-submit" onclick="window.submitName()" style="margin-top: 0;">
                    Ti·∫øp <i class="fas fa-arrow-right"></i>
                </button>
            </div>
            <p id="ip-loading" style="font-size:0.8rem; color:#666; margin-top:5px;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
    </div>

    <!-- STAGE 2: B·∫¨T ƒê√àN -->
    <div id="stage-2" class="flex-center hidden">
        <div class="light-bulbs-container" id="bulbs-container"></div>
        <button id="light-btn" class="btn" onclick="window.clickLight()">
            <i class="fas fa-lightbulb"></i> B·∫≠t ƒë√®n
        </button>
    </div>

    <!-- STAGE 3 (MAIN): KHUNG C·∫¢NH NOEL 3D -->
    <div id="stage-3" class="hidden">
        <div class="mountain-1"></div>
        <div class="mountain-2"></div>
        <div class="mountain-bg"></div>
        
        <div id="canvas-3d-container"></div>
        <div id="ai-loader">
            <i class="fas fa-hand-sparkles"></i> Cho ph√©p Camera ƒë·ªÉ d√πng tay t∆∞∆°ng t√°c!<br>
            <span style="font-size:0.8em; font-weight:normal;">(N·∫Øm: C√¢y th∆∞·ªùng ‚Ä¢ X√≤e: Bung c√¢y ‚Ä¢ Ch·ª•m: L·∫•y qu√†)</span>
        </div>

        <div class="fireworks-container" id="fireworks-container"></div>
        <div class="clouds-container">
            <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/cloud.png?alt=media&token=acc83aac-8e9c-4783-8c6f-2a2531257d38" class="cloud" style="top: 8%; animation-duration: 40s;">
            <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/cloud.png?alt=media&token=acc83aac-8e9c-4783-8c6f-2a2531257d38" class="cloud" style="top: 20%; animation-duration: 55s; left: -150px; opacity: 0.5;">
        </div>
        
        <div class="snow-hill"></div>
        
        <div class="santa-fly">
            <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/santa.png?alt=media&token=a81ad9d6-4f75-498e-9ba4-3e28673c942f" alt="Santa">
        </div>
        
        <!-- H·ªôp qu√† trang tr√≠ nhi·ªÅu h∆°n ·ªü 2 b√™n -->
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="decor-gift" style="bottom: 10vh; left: 10%; width: 65px;">
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="decor-gift" style="bottom: 8vh; right: 18%; width: 80px; filter: hue-rotate(90deg) drop-shadow(0 0 5px white);">
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="decor-gift" style="bottom: 12vh; left: 20%; width: 50px; filter: hue-rotate(180deg);">
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="decor-gift" style="bottom: 9vh; right: 10%; width: 55px; filter: hue-rotate(270deg);">

        <!-- H·ªôp qu√† ƒë·∫∑c bi·ªát -->
        <div id="special-gift-container">
            <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="big-gift-img" onclick="window.openSpecialGift()">
            <div class="btn" style="padding: 5px 20px; font-size: 1.1rem; margin-top: 10px;" onclick="window.openSpecialGift()">M·ªü Ngay üéÅ</div>
        </div>

        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/logo-tiktok.png?alt=media&token=4473a42a-e492-4a4d-8821-ed9348ac2339" class="tiktok-logo" alt="TikTok" onclick="window.handleTikTokClick()">
    </div>
    
    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <div id="webcam-wrapper">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="webcam-preview"></canvas>
    </div>

    <!-- MODAL H∆Ø·ªöNG D·∫™N -->
    <div id="guide-modal" class="modal">
        <div class="modal-content">
            <h3 style="color: var(--primary-green); font-family: 'Mountains of Christmas', cursive; font-size: 2rem;">üéÑ H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng üéÑ</h3>
            <div class="guide-text">
                <ul>
                    <li><b>B∆∞·ªõc 1:</b> Nh·∫≠p t√™n v√† b·∫≠t ƒë√®n ƒë·ªÉ v√†o kh√¥ng gian Gi√°ng Sinh.</li>
                    <li><b>B∆∞·ªõc 2 (Camera):</b> D√πng c√°c c·ª≠ ch·ªâ tay ƒë·ªÉ t∆∞∆°ng t√°c:
                        <ul>
                            <li>‚úä <b>N·∫Øm b√†n tay:</b> C√¢y th√¥ng b√¨nh th∆∞·ªùng.</li>
                            <li>üñê <b>X√≤e b√†n tay:</b> C√¢y bung ra (Explode), ng√¥i sao t·ªèa s√°ng.</li>
                            <li>üëå <b>Ch·ª•m 2 ng√≥n (C√°i & Tr·ªè):</b> B·∫Øt l·∫•y qu√† tr√™n c√¢y ƒë·ªÉ m·ªü.</li>
                            <li>üëã <b>Ph·∫©y tay (Tr√°i/Ph·∫£i):</b> Xoay c√¢y th√¥ng.</li>
                        </ul>
                    </li>
                    <li><b>B∆∞·ªõc 3:</b> M·ªü H·ªôp Qu√† L·ªõn ·ªü ch√¢n c√¢y (ch·ªâ m·ªü ƒë∆∞·ª£c 1 l·∫ßn).</li>
                    <li><b>B∆∞·ªõc 4:</b> Chia s·∫ª l·ªùi ch√∫c v√† ·∫£nh l√™n c√¢y.</li>
                </ul>
            </div>
            <button class="btn" onclick="document.getElementById('guide-modal').classList.remove('active')">ƒê√£ hi·ªÉu</button>
        </div>
    </div>

    <!-- MODAL K·∫æT QU·∫¢ -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <div id="modal-body"></div>
            
            <button class="btn btn-blue" id="btn-share-community" onclick="window.toggleShareForm()" style="margin-top: 15px; font-size: 1rem; padding: 8px 15px;">
                <i class="fas fa-paper-plane"></i> G·ª≠i qu√† l·∫°i cho m·ªçi ng∆∞·ªùi
            </button>

            <div id="share-form">
                <h4>G·ª≠i qu√† c·ªßa b·∫°n</h4>
                
                <div id="share-input-combined">
                    <textarea id="user-wish-input" placeholder="Vi·∫øt l·ªùi ch√∫c c·ªßa b·∫°n v√†o ƒë√¢y... (B·∫Øt bu·ªôc)" style="margin-bottom: 10px;"></textarea>
                    
                    <input type="text" id="user-image-url" placeholder="D√°n link ·∫£nh (URL) v√†o ƒë√¢y... (T√πy ch·ªçn)">
                    <p style="font-size: 0.85rem; color: #555; margin-top: 5px;">
                        üí° <b>M·∫πo:</b> B·∫°n c√≥ th·ªÉ d√πng <a href="https://postimages.org/" target="_blank" style="color: var(--primary-red); font-weight: bold;">postimages.org</a> ƒë·ªÉ upload ·∫£nh v√† copy <b>"Direct Link"</b> d√°n v√†o ƒë√¢y.
                    </p>
                </div>

                <button class="btn" onclick="window.submitUserGift()" style="font-size: 1rem; padding: 5px 20px; margin-top: 10px;">G·ª≠i ƒëi</button>
            </div>

            <button class="btn" onclick="window.closeModal()" style="margin-top: 20px; background: #555; padding: 8px 20px; font-size: 1rem;">ƒê√≥ng</button>
        </div>
    </div>

    <audio id="bg-music" loop>
        <source src="nhacnoel.mp3" type="audio/mp3">
    </audio>
    <audio id="effect-music"></audio>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-XIGfD-kVod2O9SeQJetwikxCOOd4qfj9iYHazO_GIRrQsyp6jyGcEOR9mgrY-i6APQ/exec";
        
        // PH√ÇN LO·∫†I QU√Ä:
        let systemGifts = []; // Qu√† m·∫∑c ƒë·ªãnh
        let userGifts = [];   // Qu√† t·ª´ ng∆∞·ªùi d√πng
        
        let userName = "";
        let userIp = "";
        let clickCount = 0;
        const requiredClicks = 3;
        
        // --- 3D & AI VARIABLES ---
        let scene, camera, renderer, composer, mainGroup, particleSystem = [];
        let starMesh; // Reference to the star
        let clock = new THREE.Clock();
        let handLandmarker, video;
        let is3DRunning = false;
        
        const STATE = {
            mode: 'TREE', 
            focusTarget: null,
            focusTimer: 0,
            hand: { detected: false, x: 0, y: 0 },
            rotation: { x: 0, y: 0 } 
        };

        const CONFIG = {
            colors: { 
                // M√†u t∆∞∆°i h∆°n
                champagneGold: 0xffd700, 
                deepGreen: 0x008000, 
                accentRed: 0xff0000, 
                metallicOrange: 0xff8800 
            },
            particles: { count: 2500, treeHeight: 20, treeRadius: 7 }
        };

        window.onload = function() {
            document.getElementById('btn-submit').disabled = true;
            getIpAddress();
            fetchCommunityGifts(); 

            initMediaPipe().then(() => {
                document.getElementById('ai-loader').innerHTML = "<i class='fas fa-check'></i> AI ƒê√£ S·∫µn S√†ng<br>‚úä N·∫Øm: C√¢y th∆∞·ªùng | üñê X√≤e: Bung c√¢y | üëå Ch·ª•m: L·∫•y qu√†";
            });

            document.body.addEventListener('click', function playAudio() {
                const audio = document.getElementById('bg-music');
                if(audio.paused) audio.play().catch(e => console.log(e));
                document.body.removeEventListener('click', playAudio);
            }, { once: true });
        };

        async function getIpAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                userIp = data.ip;
                document.getElementById('ip-loading').innerText = "ƒê√£ k·∫øt n·ªëi!";
                document.getElementById('btn-submit').disabled = false;
            } catch (error) {
                userIp = "offline";
                document.getElementById('ip-loading').innerText = "Offline Mode";
                document.getElementById('btn-submit').disabled = false;
            }
        }

        function fetchCommunityGifts() {
            systemGifts = [
                { text: "Ch√∫c b·∫°n m·ªôt m√πa gi√°ng sinh an l√†nh!", image: "", sender: "√îng gi√† Noel" },
                { text: "Merry Christmas & Happy New Year!", image: "", sender: "Tu·∫ßn l·ªôc m≈©i ƒë·ªè" },
                { text: "Ch√∫c b·∫°n lu√¥n vui v·∫ª v√† h·∫°nh ph√∫c!", image: "", sender: "Ng∆∞·ªùi b·∫°n b√≠ ·∫©n" },
                { text: "Gi√°ng sinh ·∫•m √°p b√™n gia ƒë√¨nh nh√©!", image: "", sender: "C√¥ b√© b√°n di√™m" }
            ];

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST", mode: "no-cors", 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: "GetGifts" })
            }).then(() => console.log("Fetch sent.")).catch(e => console.log(e));
        }

        window.submitName = function() {
            const input = document.getElementById('user-name');
            userName = input.value.trim();
            if (!userName) { alert("B·∫°n ch∆∞a nh·∫≠p t√™n k√¨a!"); return; }
            sendToGoogleSheet(userName, userIp, "Login", "V√†o trang");
            document.getElementById('stage-1').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('stage-1').style.display = 'none';
                document.getElementById('stage-2').classList.remove('hidden');
                document.getElementById('stage-2').style.opacity = 1;
                createBulbs();
            }, 500);
        }

        window.showGuideModal = function() {
            document.getElementById('guide-modal').classList.add('active');
        }

        window.showToast = function(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<i class="fas fa-check-circle"></i> <span>${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        function createBulbs() {
            const container = document.getElementById('bulbs-container');
            const colors = ['#ffd700', '#ff4500', '#00ff00', '#ff0000', '#800080'];
            for (let i = 0; i < 7; i++) {
                const bulbsInRow = i + 1; 
                const rowWidth = bulbsInRow * 40; 
                for (let j = 0; j < bulbsInRow; j++) {
                    const bulb = document.createElement('div');
                    bulb.classList.add('bulb');
                    bulb.style.top = (20 + i * 8) + '%'; 
                    bulb.style.left = `calc(50% - ${rowWidth/2}px + ${j * 40}px + 20px)`; 
                    bulb.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    container.appendChild(bulb);
                }
            }
        }

        window.clickLight = function() {
            clickCount++;
            const bulbs = document.querySelectorAll('.bulb');
            bulbs.forEach(b => {
                setTimeout(() => { b.classList.add('on'); setTimeout(() => b.classList.remove('on'), 800); }, Math.random() * 500);
            });

            if (clickCount >= requiredClicks) {
                const btn = document.getElementById('light-btn');
                btn.innerHTML = "ƒêang k·∫øt n·ªëi ƒëi·ªán...";
                btn.disabled = true;
                setTimeout(() => {
                    document.getElementById('stage-2').classList.add('hidden');
                    document.getElementById('stage-3').classList.remove('hidden');
                    document.getElementById('stage-3').style.opacity = 1;
                    startScene();
                }, 1500);
            }
        }

        function startScene() {
            init3DScene(); 
            const audio = document.getElementById('bg-music');
            audio.volume = 0.6;
            audio.play().catch(e => console.log("Autoplay blocked"));
            setInterval(createSnowflake, 150);
            setInterval(launchFirework, 800);
            setTimeout(() => {
                document.getElementById('special-gift-container').classList.add('show');
            }, 5000); 
        }

        // --- 3D SCENE ---
        function init3DScene() {
            if(is3DRunning) return;
            is3DRunning = true;
            const container = document.getElementById('canvas-3d-container');
            scene = new THREE.Scene();
            scene.background = null; 
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 35); 
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ReinhardToneMapping; 
            container.appendChild(renderer.domElement);

            mainGroup = new THREE.Group();
            mainGroup.position.y = 2; 
            scene.add(mainGroup);

            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);
            const spotGold = new THREE.SpotLight(0xffcc66, 800);
            spotGold.position.set(30, 40, 40);
            scene.add(spotGold);

            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.6; bloomPass.strength = 0.4; bloomPass.radius = 0.5;
            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            createParticles();
            animate3D();
        }

        // T·∫°o h√¨nh ng√¥i sao
        function createStarShape() {
            const shape = new THREE.Shape();
            const outerRadius = 1.2;
            const innerRadius = 0.6;
            const points = 5;
            const step = Math.PI / points;
            
            shape.moveTo(0, outerRadius);
            for(let i = 0; i < 2 * points; i++) {
                const r = (i % 2 === 1) ? outerRadius : innerRadius;
                const a = (i + 1) * step;
                shape.lineTo(Math.sin(a) * r, Math.cos(a) * r);
            }
            shape.closePath();
            return shape;
        }

        function createParticles() {
            const sphereGeo = new THREE.SphereGeometry(0.5, 16, 16); 
            const boxGeo = new THREE.BoxGeometry(0.5, 0.5, 0.5); 
            const goldMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.champagneGold, metalness: 0.8, roughness: 0.2, emissive: 0x443300 });
            const greenMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.deepGreen, metalness: 0.1, roughness: 0.8 });
            const redMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.accentRed, metalness: 0.3, roughness: 0.4, emissive: 0x330000 });
            const orangeMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.metallicOrange, metalness: 0.9, roughness: 0.1, emissive: 0xaa4400 });

            for (let i = 0; i < CONFIG.particles.count; i++) {
                const rand = Math.random();
                let mesh, type = 'DECOR';
                if (rand < 0.5) { mesh = new THREE.Mesh(boxGeo, greenMat); } 
                else if (rand < 0.7) { mesh = new THREE.Mesh(sphereGeo, goldMat); } 
                else if (rand < 0.85) { mesh = new THREE.Mesh(sphereGeo, redMat); } 
                else { mesh = new THREE.Mesh(sphereGeo, orangeMat); type = 'GIFT_PARTICLE'; }

                const s = 0.3 + Math.random() * 0.4;
                mesh.scale.set(s,s,s);
                mainGroup.add(mesh);
                
                const h = CONFIG.particles.treeHeight;
                const halfH = h / 2;
                let t = Math.random(); t = Math.pow(t, 0.8); 
                const y = (t * h) - halfH + 1; 
                let rMax = CONFIG.particles.treeRadius * (1.0 - t); 
                const angle = t * 40 * Math.PI + Math.random() * Math.PI; 
                const r = rMax * (0.8 + Math.random() * 0.4); 
                const posTree = new THREE.Vector3(Math.cos(angle)*r, y, Math.sin(angle)*r);

                const rScatter = 10 + Math.random() * 15;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                const posScatter = new THREE.Vector3(rScatter * Math.sin(phi) * Math.cos(theta), rScatter * Math.sin(phi) * Math.sin(theta), rScatter * Math.cos(phi));

                particleSystem.push({
                    mesh: mesh, posTree: posTree, posScatter: posScatter, type: type, baseScale: s,
                    spin: new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5)
                });
            }
            
            // T·∫†O NG√îI SAO 3D
            const starShape = createStarShape();
            const starGeo = new THREE.ExtrudeGeometry(starShape, { depth: 0.4, bevelEnabled: true, bevelThickness: 0.1, bevelSize: 0.1, bevelSegments: 2 });
            const starMat = new THREE.MeshStandardMaterial({ color: 0xffdd00, emissive: 0xffaa00, emissiveIntensity: 0.8, metalness: 0.8, roughness: 0.2 });
            starMesh = new THREE.Mesh(starGeo, starMat);
            starMesh.position.set(0, CONFIG.particles.treeHeight/2 + 2, 0); 
            mainGroup.add(starMesh);
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            const dt = clock.getDelta();
            if (STATE.hand.detected) {
                STATE.rotation.y += (STATE.hand.x * 2.5 - STATE.rotation.y) * 3 * dt;
            } else {
                STATE.rotation.y += (STATE.mode === 'TREE' ? 0.3 : 0.1) * dt;
            }
            mainGroup.rotation.y = THREE.MathUtils.lerp(mainGroup.rotation.y, STATE.rotation.y, 0.1);
            
            // Star Logic
            if (starMesh) {
                if (STATE.mode === 'SCATTER') {
                    // Khi x√≤e tay, ng√¥i sao xoay tr√≤n t·∫°i ch·ªó
                    starMesh.rotation.y += 2 * dt;
                    starMesh.rotation.z = Math.sin(clock.getElapsedTime()*3) * 0.1;
                    starMesh.scale.setScalar(1.5);
                } else {
                    starMesh.rotation.y += 0.5 * dt;
                    starMesh.rotation.z = 0;
                    starMesh.scale.setScalar(1.0);
                }
            }

            particleSystem.forEach(p => {
                let target = (STATE.mode === 'TREE') ? p.posTree : p.posScatter;
                let s = p.baseScale;
                if (STATE.mode === 'FOCUS' && p.mesh === STATE.focusTarget) {
                    const inv = mainGroup.matrixWorld.clone().invert();
                    const worldTarget = new THREE.Vector3(0, 0, 32).applyMatrix4(inv);
                    target = worldTarget; s = 3.0;
                    p.mesh.lookAt(camera.position);
                    p.mesh.rotateY(clock.getElapsedTime() * 2);
                } else if (STATE.mode === 'SCATTER' && p.type === 'PHOTO') { s = 2.0; }
                p.mesh.position.lerp(target, 3 * dt);
                p.mesh.scale.lerp(new THREE.Vector3(s,s,s), 4 * dt);
                if (STATE.mode === 'SCATTER') {
                    p.mesh.rotation.x += p.spin.x * dt;
                    p.mesh.rotation.y += p.spin.y * dt;
                } else if (STATE.mode === 'TREE' && STATE.mode !== 'FOCUS') {
                    p.mesh.rotation.set(0,0,0);
                }
            });
            composer.render();
            predictWebcam();
        }

        async function initMediaPipe() {
            video = document.getElementById('webcam');
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
                runningMode: "VIDEO", numHands: 1
            });
            if (navigator.mediaDevices?.getUserMedia) {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            }
        }

        let lastVideoTime = -1;
        
        function predictWebcam() {
            if (!handLandmarker || !video || video.currentTime === lastVideoTime) return;
            
            if (document.getElementById('result-modal').classList.contains('active') || 
                document.getElementById('guide-modal').classList.contains('active')) {
                return;
            }

            lastVideoTime = video.currentTime;
            const result = handLandmarker.detectForVideo(video, performance.now());
            
            if (result.landmarks && result.landmarks.length > 0) {
                STATE.hand.detected = true;
                const lm = result.landmarks[0];
                STATE.hand.x = (lm[9].x - 0.5) * 2; 
                STATE.hand.y = (lm[9].y - 0.5) * 2;

                const thumb = lm[4]; const index = lm[8]; const wrist = lm[0];
                const pinchDist = Math.hypot(thumb.x - index.x, thumb.y - index.y);
                
                const tips = [lm[8], lm[12], lm[16], lm[20]];
                let avgDist = 0; 
                tips.forEach(t => avgDist += Math.hypot(t.x - wrist.x, t.y - wrist.y));
                avgDist /= 4;

                if (avgDist < 0.3) { 
                    if(STATE.mode !== 'FOCUS') STATE.mode = 'TREE';
                } 
                else if (avgDist > 0.45) { 
                    if(STATE.mode !== 'FOCUS') STATE.mode = 'SCATTER';
                } 
                else if (pinchDist < 0.06) { 
                    if (STATE.mode !== 'FOCUS') {
                        const candidates = particleSystem.filter(p => p.type === 'PHOTO' || p.type === 'GIFT_PARTICLE');
                        const randomTarget = candidates.length > 0 ? candidates[Math.floor(Math.random() * candidates.length)] : particleSystem[Math.floor(Math.random() * particleSystem.length)];
                        
                        STATE.mode = 'FOCUS'; 
                        STATE.focusTarget = randomTarget.mesh;
                        
                        if(STATE.focusTimeout) clearTimeout(STATE.focusTimeout);
                        STATE.focusTimeout = setTimeout(() => {
                            window.openTreeGift();
                            STATE.mode = 'TREE'; STATE.focusTarget = null;
                        }, 1200);
                    }
                }
            } else { 
                STATE.hand.detected = false; 
            }
        }

        // LOGIC TIKTOK ADMIN
        let tiktokClicks = 0;
        let tiktokTimer = null;

        window.handleTikTokClick = function() {
            tiktokClicks++;
            if (tiktokClicks === 1) {
                tiktokTimer = setTimeout(() => {
                    if (tiktokClicks < 3) {
                        window.open('https://www.tiktok.com/@l0t968ooo', '_blank');
                    }
                    tiktokClicks = 0;
                }, 500); // ƒê·ª£i 500ms xem c√≥ click ti·∫øp kh√¥ng
            } else if (tiktokClicks === 3) {
                clearTimeout(tiktokTimer); // H·ªßy m·ªü tiktok
                const pass = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin:");
                if (pass === "123456") {
                    window.open("https://docs.google.com/spreadsheets/u/0/", "_blank");
                } else if (pass) {
                    alert("Sai m·∫≠t kh·∫©u!");
                }
                tiktokClicks = 0;
            }
        }

        // ... C√°c ph·∫ßn logic c√≤n l·∫°i (Static Wishes, Media Gifts, Audio, Modal) gi·ªØ nguy√™n ...
        
        const staticWishes = [
            "Ch√∫c b·∫°n {name} m·ªôt m√πa Gi√°ng sinh th·∫≠t an l√†nh v√† tr·ªçn v·∫πn. Mong r·∫±ng nh·ªØng kho·∫£nh kh·∫Øc trong m√πa l·ªÖ n√†y s·∫Ω mang ƒë·∫øn cho b·∫°n s·ª± ·∫•m √°p, b√¨nh y√™n v√† ni·ªÅm vui lan t·ªèa trong t·ª´ng ng√†y.",
            "Merry Christmas! Ch√∫c b·∫°n {name} lu√¥n m·ªâm c∆∞·ªùi v√† h·∫°nh ph√∫c trong su·ªët m√πa l·ªÖ h·ªôi. Hy v·ªçng ti·∫øng chu√¥ng Gi√°ng sinh s·∫Ω mang ƒë·∫øn cho b·∫°n nh·ªØng ƒëi·ªÅu may m·∫Øn v√† nh·ªØng c∆° h·ªôi m·ªõi th·∫≠t tuy·ªát v·ªùi.",
            "Gi√°ng sinh l·∫°i ƒë·∫øn, ch√∫c b·∫°n {name} ƒë√≥n m√πa l·ªÖ trong y√™u th∆∞∆°ng v√† s·ª± quan t√¢m c·ªßa nh·ªØng ng∆∞·ªùi th√¢n y√™u. Mong r·∫±ng m·ªçi ∆∞·ªõc m∆° c·ªßa b·∫°n s·∫Ω tr·ªü th√†nh hi·ªán th·ª±c khi nƒÉm m·ªõi ƒëang ƒë·∫øn g·∫ßn.",
            "Ch√∫c b·∫°n {name} m·ªôt Gi√°ng sinh vui v·∫ª v√† ƒë·∫ßy √Ω nghƒ©a. Hy v·ªçng nh·ªØng ng√†y cu·ªëi nƒÉm s·∫Ω mang theo h·∫°nh ph√∫c, s·ª± b√¨nh an v√† th·∫≠t nhi·ªÅu ƒëi·ªÅu t·ªët ƒë·∫πp ƒë·ªÉ b·∫°n b·∫Øt ƒë·∫ßu m·ªôt ch·∫∑ng ƒë∆∞·ªùng m·ªõi.",
            "Gi√°ng sinh vui v·∫ª! Mong r·∫±ng √°nh ƒë√®n lung linh v√† kh√¥ng kh√≠ ·∫•m √°p m√πa n√†y s·∫Ω ƒëem l·∫°i cho b·∫°n {name} th·∫≠t nhi·ªÅu ti·∫øng c∆∞·ªùi, nh·ªØng k·ª∑ ni·ªám ƒë·∫πp v√† nh·ªØng gi√¢y ph√∫t h·∫°nh ph√∫c kh√≥ qu√™n.",
            "Ch√∫c b·∫°n {name} m√πa Noel tr√†n ng·∫≠p ni·ªÅm vui, s·ª©c kh·ªèe v√† b√¨nh an. Hy v·ªçng b·∫°n s·∫Ω c√≥ th·ªùi gian th·∫≠t ƒë·∫πp b√™n gia ƒë√¨nh, b·∫°n b√® v√† nh·ªØng ng∆∞·ªùi b·∫°n qu√Ω tr·ªçng nh·∫•t.",
            "G·ª≠i ƒë·∫øn b·∫°n {name} l·ªùi ch√∫c Noel th·∫≠t ch√¢n th√†nh: mong b·∫°n lu√¥n m·∫°nh m·∫Ω, may m·∫Øn v√† h·∫°nh ph√∫c. Hy v·ªçng nƒÉm m·ªõi s·∫Ω m·ªü ra nhi·ªÅu c∆° h·ªôi t·ªët ƒë·∫πp, c√≤n Gi√°ng sinh n√†y s·∫Ω l√† kh·ªüi ƒë·∫ßu ƒë·∫ßy ·∫•m √°p cho t·∫•t c·∫£."
        ];

        const mediaGifts = [
            { audio: "nhacquatang.mp3", video: "video1.mp4", title: "M√≥n qu√† √¢m nh·∫°c 1" },
            { audio: "nhacquatang2.mp3", video: "video2.mp4", title: "M√≥n qu√† √¢m nh·∫°c 2" },
            { audio: "nhacquatang3.mp3", video: "video3.mp4", title: "M√≥n qu√† √¢m nh·∫°c 3" }
        ];

        window.toggleGiftSound = function() {
            const effectAudio = document.getElementById('effect-music');
            if (effectAudio.paused) {
                effectAudio.play();
                document.getElementById('sound-btn-icon').className = 'fas fa-volume-up';
            } else {
                effectAudio.pause();
                document.getElementById('sound-btn-icon').className = 'fas fa-volume-mute';
            }
        }

        window.openSpecialGift = function() {
            const modal = document.getElementById('result-modal');
            const body = document.getElementById('modal-body');
            document.getElementById('bg-music').pause();
            
            const randType = Math.random(); 
            if(randType < 0.5) {
                const content = staticWishes[Math.floor(Math.random() * staticWishes.length)].replace(/{name}/g, userName);
                body.innerHTML = `
                    <div class="letter-gift">
                        <h3 style="text-align:center; color: var(--primary-green)">üéÑ Th∆∞ Gi√°ng Sinh üéÑ</h3>
                        <p>${content}</p>
                        <span class="signature-fr">-fr:thanhloc-</span>
                    </div>
                `;
            } else {
                const gift = mediaGifts[Math.floor(Math.random() * mediaGifts.length)];
                const effectAudio = document.getElementById('effect-music');
                effectAudio.src = gift.audio;
                effectAudio.play();
                
                body.innerHTML = `
                    <div class="santa-gift">
                        <h3 style="color: #d42426; margin-bottom: 5px;">üéÖ Ho Ho Ho!</h3>
                        <p style="font-size: 0.9rem;">√îng gi√† Noel t·∫∑ng b·∫°n m·ªôt b√†i h√°t!</p>
                        <div class="video-container">
                            <video src="${gift.video}" autoplay loop muted playsinline controls></video>
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                            <p style="margin:0; font-weight:bold; color: #333;">üéµ ${gift.title}</p>
                            <button class="btn-control" onclick="window.toggleGiftSound()">
                                <i id="sound-btn-icon" class="fas fa-volume-up"></i> B·∫≠t/T·∫Øt Ti·∫øng
                            </button>
                        </div>
                    </div>
                `;
            }

            modal.classList.add('active');
            document.getElementById('share-form').style.display = 'none';
            document.getElementById('btn-share-community').style.display = 'inline-block';
            document.getElementById('special-gift-container').style.display = 'none';
            sendToGoogleSheet(userName, userIp, "OpenedMainGift", "Success");
        }

        window.openTreeGift = function() {
            const modal = document.getElementById('result-modal');
            const body = document.getElementById('modal-body');
            document.getElementById('bg-music').pause();

            let gift;
            if (userGifts.length > 0 && Math.random() < 0.95) {
                gift = userGifts[Math.floor(Math.random() * userGifts.length)];
            } else {
                gift = systemGifts[Math.floor(Math.random() * systemGifts.length)];
            }

            let htmlContent = `<div class="letter-gift" style="background: #e0f7fa; border-color: #00bcd4; text-align:center;">`;
            if (gift.image && gift.image.trim() !== "") {
                htmlContent += `<h3 style="color: #006064">üì∏ ·∫¢nh Gi√°ng Sinh</h3>
                                <img src="${gift.image}" style="max-width:100%; border-radius:10px; margin:10px 0;" onerror="this.src='https://via.placeholder.com/300?text=L·ªói+·∫¢nh'">`;
            } else {
                htmlContent += `<h3 style="color: #006064">üéÅ L·ªùi nh·∫Øn y√™u th∆∞∆°ng</h3>`;
            }
            if (gift.text) {
                htmlContent += `<p style="margin-top:10px; color: #333;">"${gift.text}"</p>`;
            }
            htmlContent += `<div class="user-gift-meta">G·ª≠i b·ªüi: <b>${gift.sender}</b></div></div>`;

            body.innerHTML = htmlContent;
            modal.classList.add('active');
            document.getElementById('share-form').style.display = 'none';
            document.getElementById('btn-share-community').style.display = 'inline-block';
        }

        window.closeModal = function() {
            document.getElementById('result-modal').classList.remove('active');
            document.getElementById('effect-music').pause();
            document.getElementById('effect-music').currentTime = 0;
            document.getElementById('bg-music').play();
        }

        window.toggleShareForm = function() {
            const form = document.getElementById('share-form');
            const btn = document.getElementById('btn-share-community');
            form.style.display = 'block';
            btn.style.display = 'none'; 
        }

        window.submitUserGift = function() {
            const textContent = document.getElementById('user-wish-input').value;
            const imageUrl = document.getElementById('user-image-url').value;

            if (!textContent) { 
                window.showToast("B·∫°n ch∆∞a nh·∫≠p l·ªùi ch√∫c!"); 
                return; 
            }

            userGifts.push({
                text: textContent,
                image: imageUrl,
                sender: userName
            });

            const detailLog = `Text: ${textContent} | Img: ${imageUrl}`;
            sendToGoogleSheet(userName, userIp, "ShareGift", detailLog);
            
            window.showToast("ƒê√£ g·ª≠i qu√† th√†nh c√¥ng! C·∫£m ∆°n b·∫°n.");
            window.closeModal();
        }

        function sendToGoogleSheet(name, ip, type, detail) {
            let action = "Log";
            if (type === "ShareGift") action = "ShareGift";
            const data = { action: action, name: name, ip: ip, giftType: type, detail: detail };
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST", mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).catch(e => console.log("Log error:", e));
        }

        function launchFirework() {
            const container = document.getElementById('fireworks-container');
            const x = Math.random() * 100; const y = Math.random() * 40;
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div');
                p.classList.add('firework-particle');
                p.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                p.style.left = x + '%'; p.style.top = (y + 10) + '%';
                const angle = (Math.PI * 2 * i) / 20; const v = 100 + Math.random() * 100;
                p.style.setProperty('--tx', Math.cos(angle) * v + 'px');
                p.style.setProperty('--ty', Math.sin(angle) * v + 'px');
                container.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        }
        function createSnowflake() {
            const snow = document.createElement('div');
            snow.classList.add('snowflake');
            snow.innerHTML = '‚ùÑ';
            snow.style.left = Math.random() * 100 + 'vw';
            snow.style.animationDuration = Math.random() * 3 + 3 + 's';
            document.getElementById('stage-3').appendChild(snow);
            setTimeout(() => snow.remove(), 6000);
        }
    </script>
</body>
</html>
