<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi√°ng Sinh Y√™u Th∆∞∆°ng</title>
    <!-- Import font ch·ªØ ƒë·∫πp -->
    <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@700&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome cho icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- CSS --- */
        :root { --primary-red: #d42426; --primary-green: #165b33; --gold: #ffd700; }
        body { margin: 0; padding: 0; font-family: 'Quicksand', sans-serif; overflow: hidden; background-color: #0f172a; height: 100vh; width: 100vw; color: white; }
        .hidden { display: none !important; }
        .flex-center { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; text-align: center; }
        .btn { background: var(--primary-red); color: white; border: 2px solid white; padding: 12px 30px; font-size: 1.2rem; border-radius: 25px; cursor: pointer; font-family: 'Mountains of Christmas', cursive; transition: all 0.3s; box-shadow: 0 4px 15px rgba(212, 36, 38, 0.5); margin-top: 20px; z-index: 100; position: relative; }
        .btn:hover { transform: scale(1.05); background: #b01b1d; }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { background: #555; cursor: not-allowed; border-color: #777; box-shadow: none; }
        
        #stage-1 { background: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://images.unsplash.com/photo-1543589077-47d81606c1bf?q=80&w=1920&auto=format&fit=crop'); background-size: cover; background-position: center; }
        .input-box { background: rgba(255, 255, 255, 0.9); padding: 30px; border-radius: 15px; box-shadow: 0 0 20px rgba(255, 215, 0, 0.3); color: #333; max-width: 90%; width: 350px; }
        .input-box h2 { font-family: 'Mountains of Christmas', cursive; font-size: 2rem; color: var(--primary-green); margin-top: 0; }
        input[type="text"] { width: 80%; padding: 10px; border: 2px solid var(--primary-green); border-radius: 5px; font-size: 1rem; text-align: center; outline: none; }
        
        #stage-2 { background-color: #000; position: relative; }
        .light-bulbs-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .bulb { position: absolute; width: 15px; height: 15px; border-radius: 50%; background: #222; transition: all 0.2s; opacity: 0; }
        .bulb.on { opacity: 1; box-shadow: 0 0 15px 5px currentColor; animation: flash 0.8s ease-in-out; }
        @keyframes flash { 0% { transform: scale(1); opacity: 0; } 10% { transform: scale(1.5); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(1); opacity: 0; } }
        
        #stage-3 { background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); position: relative; height: 100vh; width: 100vw; overflow: hidden; }
        .fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2; }
        .firework-particle { position: absolute; width: 6px; height: 6px; border-radius: 50%; animation: explode 1s ease-out forwards; }
        @keyframes explode { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }
        .clouds-container { position: absolute; top: 0; left: 0; width: 100%; height: 50%; pointer-events: none; z-index: 1; }
        .cloud { position: absolute; width: 150px; opacity: 0.7; animation: floatCloud 30s linear infinite; }
        @keyframes floatCloud { from { transform: translateX(-200px); } to { transform: translateX(110vw); } }
        
        /* --- ƒêI·ªÄU CH·ªàNH V·ªä TR√ç CAO H∆†N CHO MOBILE --- */
        .snow-hill { position: absolute; bottom: 0; left: 0; width: 100%; height: 35vh; background: white; border-radius: 100% 100% 0 0 / 50% 50% 0 0; transform: scaleX(1.5); z-index: 1; box-shadow: 0 0 30px rgba(255, 255, 255, 0.8); }
        
        .christmas-tree { position: absolute; bottom: 15vh; left: 50%; transform: translateX(-50%); z-index: 5; width: 260px; height: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; }
        .tree-img { width: 100%; height: auto; filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6)); }
        .tree-light { position: absolute; width: 10px; height: 10px; border-radius: 50%; z-index: 6; animation: treeBlink 1.5s infinite alternate; }
        @keyframes treeBlink { from { opacity: 0.6; transform: scale(0.8); box-shadow: 0 0 3px currentColor; } to { opacity: 1; transform: scale(1.2); box-shadow: 0 0 10px currentColor; } }
        
        .star-top { 
            font-size: 3rem; 
            color: #ffd700; 
            position: absolute; 
            top: -6%; 
            left: 53.5%; 
            transform: translateX(-50%); 
            filter: drop-shadow(0 0 15px gold); 
            animation: twinkle 1s infinite alternate; 
            z-index: 10; 
        }
        @keyframes twinkle { from { transform: translateX(-50%) scale(1); opacity: 0.8; } to { transform: translateX(-50%) scale(1.2); opacity: 1; } }
        
        .santa-fly { position: absolute; top: 10%; left: -300px; width: 250px; z-index: 4; animation: flyAcross 20s linear infinite; }
        .santa-fly img { width: 100%; }
        @keyframes flyAcross { 0% { transform: translateX(0) translateY(0); } 25% { transform: translateX(30vw) translateY(-40px); } 50% { transform: translateX(60vw) translateY(0); } 75% { transform: translateX(90vw) translateY(-40px); } 100% { transform: translateX(120vw) translateY(0); } }
        
        .decor-gift { position: absolute; z-index: 6; filter: drop-shadow(0 0 8px rgba(255,255,255,0.6)); transition: transform 0.3s; }
        .decor-gift:hover { transform: scale(1.1) translateY(-5px); }
        
        #special-gift-container { position: absolute; bottom: 18vh; left: 50%; transform: translateX(-50%) scale(0); z-index: 100; transition: transform 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; }
        #special-gift-container.show { transform: translateX(-50%) scale(1); }
        .big-gift-img { width: 140px; cursor: pointer; filter: drop-shadow(0 0 20px gold); animation: shake 2s infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-8deg); } 75% { transform: rotate(8deg); } }
        
        .snowflake { position: absolute; top: -10px; color: #fff; font-size: 1em; font-family: Arial, sans-serif; text-shadow: 0 0 5px #000; z-index: 5; animation: fall linear infinite; }
        @keyframes fall { to { transform: translateY(105vh); } }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s; }
        .modal.active { opacity: 1; pointer-events: all; }
        .modal-content { background: #fffafa; color: #333; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; text-align: center; border: 5px solid var(--primary-red); position: relative; max-height: 80vh; overflow-y: auto; box-shadow: 0 0 50px rgba(212, 36, 38, 0.5); }
        .santa-gift img { width: 80%; border-radius: 10px; margin-bottom: 10px; }
        .letter-gift { background: #fffde7; padding: 20px; border: 1px dashed #999; font-family: 'Times New Roman', serif; font-size: 1.2rem; line-height: 1.6; text-align: left; }
        .money-gift { color: var(--primary-red); font-weight: bold; }
        .money-amount { font-size: 3.5rem; color: #d4ac0d; margin: 10px 0; text-shadow: 2px 2px 0px #fff; }
        .messenger-btn { background: #0084ff; color: white; text-decoration: none; padding: 12px 25px; border-radius: 25px; display: inline-block; margin-top: 15px; font-weight: bold; box-shadow: 0 4px 10px rgba(0, 132, 255, 0.3); }
        .tiktok-logo { position: fixed; bottom: 20px; left: 20px; width: 50px; z-index: 150; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5)); cursor: pointer; transition: transform 0.1s; }
        .tiktok-logo:active { transform: scale(0.9); }
        #audio-player { display: none; }
        .gift-tag { padding: 2px 5px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .tag-money { background: #ffd700; color: #d42426; }
        .tag-santa { background: #ffcccc; color: #d42426; }
        .tag-wish { background: #e0e0e0; color: #333; }
        .detail-info { font-size: 0.85rem; color: #555; display: block; margin-top: 2px; }
        .admin-note { font-size: 0.9rem; margin-bottom: 15px; color: #555; font-style: italic; }
        .sheet-link { display: inline-block; padding: 10px 20px; background: #165b33; color: white; text-decoration: none; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>

    <!-- STAGE 1: NH·∫¨P T√äN -->
    <div id="stage-1" class="flex-center">
        <div class="input-box">
            <h2><i class="fas fa-sleigh"></i> Ch√†o b·∫°n!</h2>
            <p>Cho m√¨nh bi·∫øt t√™n b·∫°n l√† g√¨ nh·ªâ?</p>
            <input type="text" id="user-name" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n...">
            <button class="btn" id="btn-submit" onclick="submitName()">Ti·∫øp <i class="fas fa-arrow-right"></i></button>
            <p id="ip-loading" style="font-size:0.8rem; color:#666; margin-top:5px;">ƒêang t·∫£i d·ªØ li·ªáu...</p>
        </div>
    </div>

    <!-- STAGE 2: M√ÄN H√åNH T·ªêI & B·∫¨T ƒê√àN -->
    <div id="stage-2" class="flex-center hidden">
        <div class="light-bulbs-container" id="bulbs-container"></div>
        <button id="light-btn" class="btn" onclick="clickLight()">
            <i class="fas fa-lightbulb"></i> B·∫≠t ƒë√®n
        </button>
    </div>

    <!-- STAGE 3 (MAIN): KHUNG C·∫¢NH NOEL -->
    <div id="stage-3" class="hidden">
        <div class="fireworks-container" id="fireworks-container"></div>
        <div class="clouds-container">
            <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/cloud.png?alt=media&token=acc83aac-8e9c-4783-8c6f-2a2531257d38" class="cloud" style="top: 8%; animation-duration: 40s;">
            <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/cloud.png?alt=media&token=acc83aac-8e9c-4783-8c6f-2a2531257d38" class="cloud" style="top: 20%; animation-duration: 55s; left: -150px; opacity: 0.5;">
            <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/cloud.png?alt=media&token=acc83aac-8e9c-4783-8c6f-2a2531257d38" class="cloud" style="top: 5%; animation-duration: 35s; right: -150px; opacity: 0.6;">
        </div>
        <div class="snow-hill"></div>
        <div class="christmas-tree" id="tree-container">
            <div class="star-top"><i class="fas fa-star"></i></div>
            <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/pineTree.png?alt=media&token=2d82b851-6e4e-4518-a7a8-e06126b47e34" class="tree-img" alt="Tree">
        </div>
        <div class="santa-fly">
            <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/santa.png?alt=media&token=a81ad9d6-4f75-498e-9ba4-3e28673c942f" alt="Santa">
        </div>
        
        <!-- H·ªôp qu√† trang tr√≠ -->
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="decor-gift" style="bottom: 22vh; left: 10%; width: 65px;">
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="decor-gift" style="bottom: 20vh; right: 18%; width: 80px; filter: hue-rotate(90deg) drop-shadow(0 0 5px white);">
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="decor-gift" style="bottom: 24vh; right: 8%; width: 55px; filter: hue-rotate(45deg) drop-shadow(0 0 5px white);">
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="decor-gift" style="bottom: 22vh; left: 22%; width: 45px; filter: hue-rotate(180deg) drop-shadow(0 0 5px white);">
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="decor-gift" style="bottom: 25vh; left: 30%; width: 40px; filter: hue-rotate(270deg);">
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="decor-gift" style="bottom: 21vh; right: 30%; width: 50px; filter: hue-rotate(130deg);">

        <!-- H·ªôp qu√† ƒë·∫∑c bi·ªát -->
        <div id="special-gift-container">
            <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/Gift_Flat_Icon_Vector.svg?alt=media&token=8bb72a2d-183c-462b-a1b8-e42af9bf52e0" class="big-gift-img" onclick="openSpecialGift()">
            <div class="btn" style="padding: 5px 20px; font-size: 1.1rem; margin-top: 10px;" onclick="openSpecialGift()">M·ªü Ngay üéÅ</div>
        </div>

        <!-- Logo Tiktok -->
        <img src="https://firebasestorage.googleapis.com/v0/b/webai-54992.appspot.com/o/logo-tiktok.png?alt=media&token=4473a42a-e492-4a4d-8821-ed9348ac2339" class="tiktok-logo" alt="TikTok" onclick="handleTikTokClick()">
    </div>

    <!-- MODAL K·∫æT QU·∫¢ -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <div id="modal-body"></div>
            <button class="btn" onclick="closeModal()" style="margin-top: 20px; background: #555; padding: 8px 20px; font-size: 1rem;">ƒê√≥ng</button>
        </div>
    </div>

    <!-- MODAL ADMIN -->
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h2 style="color:#333; margin-top:0;">üìã Qu·∫£n l√Ω qu√† t·∫∑ng</h2>
            <p class="admin-note">
                D·ªØ li·ªáu hi·ªán ƒë∆∞·ª£c l∆∞u tr√™n Google Sheets.<br>
                B·∫°n h√£y m·ªü file Google Sheet c·ªßa b·∫°n ƒë·ªÉ xem danh s√°ch chi ti·∫øt.
            </p>
            <a id="sheet-link-btn" href="#" target="_blank" class="sheet-link">
                M·ªü Google Sheet <i class="fas fa-external-link-alt"></i>
            </a>
            <button class="btn" onclick="closeAdmin()" style="margin-top: 20px; background: #555; padding: 8px 20px; font-size: 1rem;">ƒê√≥ng Admin</button>
        </div>
    </div>

    <!-- AUDIO -->
    <audio id="bg-music" loop autoplay>
        <source src="nhacnoel.mp3" type="audio/mp3">
    </audio>
    <audio id="effect-music"></audio>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwjhTvWVWWLku1yEXAFwAiYrnTLiaW8YOqNTyl_kqGdTRLGQLcDfzINzA948p8BPN1TiQ/exec"; 
        const GOOGLE_SHEET_LINK = "https://docs.google.com/spreadsheets/d/1rrLlJsrGmfxkkNlx9-bx1brRJ0KC0-176iPUAncTnEI/edit?gid=0#gid=0"; 

        let userName = "";
        let userId = "";
        let userIp = ""; 
        let clickCount = 0;
        const requiredClicks = 3;
        const giftDelay = 6000;

        const wishes = [
            "Ch√∫c b·∫°n {name} m·ªôt m√πa Gi√°ng sinh th·∫≠t an l√†nh v√† tr·ªçn v·∫πn. Mong r·∫±ng nh·ªØng kho·∫£nh kh·∫Øc trong m√πa l·ªÖ n√†y s·∫Ω mang ƒë·∫øn cho b·∫°n s·ª± ·∫•m √°p, b√¨nh y√™n v√† ni·ªÅm vui lan t·ªèa trong t·ª´ng ng√†y.",
            "Merry Christmas! Ch√∫c b·∫°n {name} lu√¥n m·ªâm c∆∞·ªùi v√† h·∫°nh ph√∫c trong su·ªët m√πa l·ªÖ h·ªôi. Hy v·ªçng ti·∫øng chu√¥ng Gi√°ng sinh s·∫Ω mang ƒë·∫øn cho b·∫°n nh·ªØng ƒëi·ªÅu may m·∫Øn v√† nh·ªØng c∆° h·ªôi m·ªõi th·∫≠t tuy·ªát v·ªùi.",
            "Gi√°ng sinh l·∫°i ƒë·∫øn, ch√∫c b·∫°n {name} ƒë√≥n m√πa l·ªÖ trong y√™u th∆∞∆°ng v√† s·ª± quan t√¢m c·ªßa nh·ªØng ng∆∞·ªùi th√¢n y√™u. Mong r·∫±ng m·ªçi ∆∞·ªõc m∆° c·ªßa b·∫°n s·∫Ω tr·ªü th√†nh hi·ªán th·ª±c khi nƒÉm m·ªõi ƒëang ƒë·∫øn g·∫ßn.",
            "Ch√∫c b·∫°n {name} m·ªôt Gi√°ng sinh vui v·∫ª v√† ƒë·∫ßy √Ω nghƒ©a. Hy v·ªçng nh·ªØng ng√†y cu·ªëi nƒÉm s·∫Ω mang theo h·∫°nh ph√∫c, s·ª± b√¨nh an v√† th·∫≠t nhi·ªÅu ƒëi·ªÅu t·ªët ƒë·∫πp ƒë·ªÉ b·∫°n b·∫Øt ƒë·∫ßu m·ªôt ch·∫∑ng ƒë∆∞·ªùng m·ªõi.",
            "Gi√°ng sinh vui v·∫ª! Mong r·∫±ng √°nh ƒë√®n lung linh v√† kh√¥ng kh√≠ ·∫•m √°p m√πa n√†y s·∫Ω ƒëem l·∫°i cho b·∫°n {name} th·∫≠t nhi·ªÅu ti·∫øng c∆∞·ªùi, nh·ªØng k·ª∑ ni·ªám ƒë·∫πp v√† nh·ªØng gi√¢y ph√∫t h·∫°nh ph√∫c kh√≥ qu√™n.",
            "Ch√∫c b·∫°n {name} m√πa Noel tr√†n ng·∫≠p ni·ªÅm vui, s·ª©c kh·ªèe v√† b√¨nh an. Hy v·ªçng b·∫°n s·∫Ω c√≥ th·ªùi gian th·∫≠t ƒë·∫πp b√™n gia ƒë√¨nh, b·∫°n b√® v√† nh·ªØng ng∆∞·ªùi b·∫°n qu√Ω tr·ªçng nh·∫•t.",
            "G·ª≠i ƒë·∫øn b·∫°n {name} l·ªùi ch√∫c Noel th·∫≠t ch√¢n th√†nh: mong b·∫°n lu√¥n m·∫°nh m·∫Ω, may m·∫Øn v√† h·∫°nh ph√∫c. Hy v·ªçng nƒÉm m·ªõi s·∫Ω m·ªü ra nhi·ªÅu c∆° h·ªôi t·ªët ƒë·∫πp, c√≤n Gi√°ng sinh n√†y s·∫Ω l√† kh·ªüi ƒë·∫ßu ƒë·∫ßy ·∫•m √°p cho t·∫•t c·∫£."
        ];

        const prizes = [
            { code: "008", value: 2000, max: 2 }, 
            { code: "006", value: 3000, max: 2 }, 
            { code: "010", value: 5000, max: 1 }  
        ];

        const songList = ["nhacquatang.mp3", "nhacquatang2.mp3", "nhacquatang3.mp3"];
        const songLinks = ["nhacquatang.mp3", "nhacquatang2.mp3", "nhacquatang3.mp3"];
        
        // Danh s√°ch Video t∆∞∆°ng ·ª©ng (B·∫°n c·∫ßn t·ª± chu·∫©n b·ªã file video)
        const videoList = [
            "video1.mp4",
            "video2.mp4",
            "video3.mp4"
        ];

        function safePlay(audioElement) {
            if (audioElement) {
                const playPromise = audioElement.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Playback prevented:', error);
                    });
                }
            }
        }

        async function getIpAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                userIp = data.ip;
                document.getElementById('ip-loading').innerText = "ƒê√£ s·∫µn s√†ng!";
                document.getElementById('btn-submit').disabled = false;
            } catch (error) {
                userIp = "unknown_" + Date.now();
                document.getElementById('ip-loading').innerText = "Ch·∫ø ƒë·ªô offline";
                document.getElementById('btn-submit').disabled = false;
            }
        }
        
        window.onload = function() {
            document.getElementById('btn-submit').disabled = true;
            document.getElementById('sheet-link-btn').href = GOOGLE_SHEET_LINK;
            getIpAddress();
            
            const audio = document.getElementById('bg-music');
            safePlay(audio);
            document.body.addEventListener('click', function playAudio() {
                safePlay(audio);
                document.body.removeEventListener('click', playAudio);
            }, { once: true });
        };

        async function submitName() {
            const input = document.getElementById('user-name');
            const name = input.value.trim();
            if (!name) { alert("B·∫°n ch∆∞a nh·∫≠p t√™n k√¨a!"); return; }
            userName = name;
            userId = 'user_' + Date.now();

            sendToGoogleSheet(userName, userIp, "ƒê√£ v√†o trang", "Ch∆∞a m·ªü qu√†");

            document.getElementById('stage-1').classList.add('hidden');
            document.getElementById('stage-2').classList.remove('hidden');
            createTreeLightsStage2();
        }

        function createTreeLightsStage2() {
            const container = document.getElementById('bulbs-container');
            const colors = ['#ffd700', '#ff4500', '#00ff00', '#ff0000', '#800080'];
            
            for (let i = 0; i < 7; i++) {
                const bulbsInRow = i + 1; 
                const rowWidth = bulbsInRow * 40; 
                
                for (let j = 0; j < bulbsInRow; j++) {
                    const bulb = document.createElement('div');
                    bulb.classList.add('bulb');
                    bulb.style.top = (20 + i * 8) + '%'; 
                    bulb.style.left = `calc(50% - ${rowWidth/2}px + ${j * 40}px + 20px)`; 
                    bulb.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    container.appendChild(bulb);
                }
            }
            for(let k=0; k<2; k++) {
                const bulb = document.createElement('div');
                bulb.classList.add('bulb');
                bulb.style.top = '80%'; 
                bulb.style.left = `calc(50% - 20px + ${k * 40}px)`;
                bulb.style.backgroundColor = '#8B4513'; 
                container.appendChild(bulb);
            }
        }

        function clickLight() {
            clickCount++;
            const bulbs = document.querySelectorAll('.bulb');
            bulbs.forEach(b => {
                setTimeout(() => { b.classList.add('on'); setTimeout(() => b.classList.remove('on'), 800); }, Math.random() * 500);
            });

            if (clickCount >= requiredClicks) {
                const btn = document.getElementById('light-btn');
                btn.innerHTML = "ƒêang k·∫øt n·ªëi ƒëi·ªán...";
                btn.disabled = true;
                setTimeout(() => {
                    document.getElementById('stage-2').classList.add('hidden');
                    document.getElementById('stage-3').classList.remove('hidden');
                    startScene();
                }, 1500);
            }
        }

        function startScene() {
            const audio = document.getElementById('bg-music');
            audio.volume = 0.6;
            safePlay(audio);
            setInterval(createSnowflake, 150);
            setInterval(launchFirework, 800);
            decorateRealTree(); 
            setTimeout(() => {
                document.getElementById('special-gift-container').classList.add('show');
            }, giftDelay);
        }

        function decorateRealTree() {
            const tree = document.getElementById('tree-container');
            const colors = ['#f00', '#ff0', '#0f0', '#00f', '#fff'];
            
            for(let i=0; i<45; i++) {
                const light = document.createElement('div');
                light.classList.add('tree-light');
                const topPercent = 8 + Math.random() * 65; 
                const spreadFactor = (topPercent - 8) / 65; 
                const maxSpread = spreadFactor * 35; 
                const leftPercent = 50 + (Math.random() * maxSpread * 2 - maxSpread);
                light.style.top = topPercent + '%';
                light.style.left = leftPercent + '%';
                light.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                light.style.animationDelay = Math.random() + 's';
                tree.appendChild(light);
            }

            for(let j=0; j<6; j++) {
                const extraLight = document.createElement('div');
                extraLight.classList.add('tree-light');
                const topP = 25 + Math.random() * 50;
                const spread = (topP - 8) / 65 * 35;
                const leftP = 50 - (Math.random() * spread); 
                
                extraLight.style.top = topP + '%';
                extraLight.style.left = leftP + '%';
                extraLight.style.backgroundColor = '#ff0'; 
                extraLight.style.boxShadow = "0 0 15px gold"; 
                extraLight.style.animationDelay = Math.random() + 's';
                tree.appendChild(extraLight);
            }
        }

        function launchFirework() {
            const container = document.getElementById('fireworks-container');
            const x = Math.random() * 100;
            const y = Math.random() * 40;
            for (let i = 0; i < 20; i++) {
                const p = document.createElement('div');
                p.classList.add('firework-particle');
                p.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                p.style.left = x + '%'; p.style.top = (y + 10) + '%';
                const angle = (Math.PI * 2 * i) / 20;
                const v = 100 + Math.random() * 100;
                p.style.setProperty('--tx', Math.cos(angle) * v + 'px');
                p.style.setProperty('--ty', Math.sin(angle) * v + 'px');
                container.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        }

        function createSnowflake() {
            const snow = document.createElement('div');
            snow.classList.add('snowflake');
            snow.innerHTML = '‚ùÑ';
            snow.style.left = Math.random() * 100 + 'vw';
            snow.style.animationDuration = Math.random() * 3 + 3 + 's';
            document.getElementById('stage-3').appendChild(snow);
            setTimeout(() => snow.remove(), 6000);
        }

        function openSpecialGift() {
            const hasOpenedLocal = localStorage.getItem('noel_gift_opened');
            let giftType = 'wish';
            const rand = Math.random() * 100;

            if (rand < 5 && !hasOpenedLocal) giftType = 'money';
            else if (rand < 45) giftType = 'santa';
            else giftType = 'wish';

            let detailInfo = "";
            let giftMeta = {};

            if (giftType === 'santa') {
                const songIndex = Math.floor(Math.random() * songList.length);
                giftMeta = { songUrlIndex: songIndex };
                detailInfo = `B√†i h√°t: ${songList[songIndex]}`;
            } else if (giftType === 'wish') {
                const wishIndex = Math.floor(Math.random() * wishes.length);
                giftMeta = { wishIndex: wishIndex };
                detailInfo = `L·ªùi ch√∫c s·ªë ${wishIndex + 1}`;
            } else if (giftType === 'money') {
                const prize = prizes[Math.floor(Math.random() * prizes.length)];
                giftMeta = { prize: prize };
                detailInfo = `${prize.value}ƒë - M√£: ${prize.code}`;
            }

            sendToGoogleSheet(userName, userIp, giftType, detailInfo);

            showResult(giftType, giftMeta);
            document.getElementById('special-gift-container').classList.remove('show');
            if (giftType === 'money') localStorage.setItem('noel_gift_opened', 'true');
        }

        function sendToGoogleSheet(name, ip, giftType, detail) {
            const data = { name: name, ip: ip, giftType: giftType, detail: detail };
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            }).catch(e => console.log("G·ª≠i Google Sheet l·ªói:", e));
        }

        function showResult(type, meta) {
            const modal = document.getElementById('result-modal');
            const body = document.getElementById('modal-body');
            modal.classList.add('active');
            
            const bgMusic = document.getElementById('bg-music');
            if (bgMusic) bgMusic.pause();

            if (type === 'santa') {
                const songIndex = meta.songUrlIndex % songList.length;
                const songUrl = songLinks[songIndex];
                const videoUrl = videoList[songIndex % videoList.length];

                const effect = document.getElementById('effect-music');
                effect.src = songUrl;
                safePlay(effect);
                body.innerHTML = `
                    <div class="santa-gift">
                        <h2>üéÖ Ho Ho Ho!</h2>
                        <!-- Video thay cho GIF -->
                        <video src="${videoUrl}" autoplay loop muted playsinline style="width:100%; border-radius:10px; margin-bottom:10px;"></video>
                        
                        <p>√îng gi√† Noel h√°t t·∫∑ng b·∫°n ${userName}!</p>
                        <p style="font-weight:bold; color:var(--primary-green)">${songList[songIndex]}</p>
                        
                        <!-- N√∫t nghe nh·∫°c thay cho d√≤ng hi·ªÉn th·ªã t√™n file -->
                        <button class="btn" onclick="document.getElementById('effect-music').play()" style="padding: 5px 15px; font-size: 0.9rem; margin-top: 5px;">
                            <i class="fas fa-music"></i> ·∫§n v√†o ƒë·ªÉ nghe
                        </button>
                    </div>
                `;
            } else if (type === 'wish') {
                body.innerHTML = `<div class="letter-gift"><h3 style="text-align:center; color: var(--primary-green)">üéÑ Th∆∞ Gi√°ng Sinh üéÑ</h3><p>${wishes[meta.wishIndex].replace(/{name}/g, `<b>${userName}</b>`)}</p><p style="text-align:right">- G·ª≠i t·ª´ Th√†nh L·ªôc ·ªü V≈© Tr·ª• NoelüéÄ -</p></div>`;
            } else if (type === 'money') {
                body.innerHTML = `<div class="money-gift"><h2>üéâ CH√öC M·ª™NG üéâ</h2><p>B·∫°n ${userName} may m·∫Øn!</p><div class="money-amount">${meta.prize.value}ƒë</div><p>M√£ tr√∫ng th∆∞·ªüng c·ªßa b·∫°n: <strong>${meta.prize.code}</strong></p><p style="font-size:0.9rem; color:#555">H√£y ch·ª•p m√†n h√¨nh v√† li√™n h·ªá Admin ngay:</p><a href="https://m.me/thanhloc2906208" target="_blank" class="messenger-btn"><i class="fab fa-facebook-messenger"></i> Nh·∫≠n th∆∞·ªüng ngay</a><p style="margin-top:10px; font-size:0.8rem; color: red;">*Ghi ch√∫: K√®m m√£ tr√∫ng th∆∞·ªüng khi nh·∫Øn tin</p></div>`;
            }
        }

        function closeModal() {
            document.getElementById('result-modal').classList.remove('active');
            
            const bgMusic = document.getElementById('bg-music');
            safePlay(bgMusic);
            
            const effectMusic = document.getElementById('effect-music');
            if (effectMusic) effectMusic.pause();
        }

        let secretClickCount = 0;
        let secretClickTimer;

        function handleTikTokClick() {
            secretClickCount++;
            clearTimeout(secretClickTimer);
            
            if (secretClickCount === 3) {
                secretClickCount = 0;
                const password = prompt("Nh·∫≠p m·∫≠t kh·∫©u Admin:", "");
                if (password === "123456") {
                    document.getElementById('admin-modal').classList.add('active');
                } else if (password !== null) {
                    alert("Sai m·∫≠t kh·∫©u!");
                }
            } else {
                secretClickTimer = setTimeout(() => {
                    if (secretClickCount === 1) {
                        window.open("https://www.tiktok.com/@l0t968ooo ", "_blank");
                    }
                    secretClickCount = 0;
                }, 400);
            }
        }

        function closeAdmin() { document.getElementById('admin-modal').classList.remove('active'); }
    </script>
</body>
</html>
